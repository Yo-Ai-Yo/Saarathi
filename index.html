<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saarathi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .sanskrit {
      font-family: 'Noto Sans Devanagari', sans-serif;
      font-weight: 600;
      color: #b89746;
    }
    .dark .sanskrit {
      color: #ffca28;
    }
    .glass {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border: 2px solid #90caf9;
      border-radius: 16px;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .dark .glass {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid #90caf9;
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .fade-in-scale {
      animation: fadeInScale 0.3s ease-in-out;
    }
    .bg-spiritual {
      background: linear-gradient(to bottom, #d1c4e9, #bbdefb);
    }
    .dark .bg-spiritual {
      background: linear-gradient(to bottom, #4a148c, #0d47a1);
    }
    .sidebar-enter {
      transform: translateX(-100%);
    }
    .sidebar-enter-active {
      transform: translateX(0);
      transition: transform 300ms ease-in-out;
    }
    .sidebar-exit {
      transform: translateX(0);
    }
    .sidebar-exit-active {
      transform: translateX(-100%);
      transition: transform 300ms ease-in-out;
    }
    .hamburger-menu {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }
    .output-block {
      background-color: #f3e8ff;
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
    }
    .dark .output-block {
      background-color: #1e1b4b;
      color: #e5e7eb;
    }
    .mic-active {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    /* Mobile-specific styles */
    @media (max-width: 640px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .hamburger-menu {
        top: 0.5rem;
        left: 0.5rem;
      }
      .sidebar {
        width: 75%;
      }
      .textarea {
        min-height: 120px;
      }
      .modal {
        width: 95%;
        margin: 0 auto;
      }
      .modal-content {
        padding: 1rem;
      }
      .button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
      }
      .icon-button {
        padding: 0.75rem;
      }
      .text-lg {
        font-size: 1rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body className="bg-spiritual min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [question, setQuestion] = useState("");
      const [response, setResponse] = useState("");
      const [shloka, setShloka] = useState("");
      const [translation, setTranslation] = useState("");
      const [explanation, setExplanation] = useState("");
      const [error, setError] = useState("");
      const [darkMode, setDarkMode] = useState(false);
      const [history, setHistory] = useState([]);
      const [showHistory, setShowHistory] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [followUpContext, setFollowUpContext] = useState(null);
      const [isListening, setIsListening] = useState(false);
      const [isSpeaking, setIsSpeaking] = useState(false);
      const [voices, setVoices] = useState([]);
      const [isVoiceSupported, setIsVoiceSupported] = useState(true);
      const [selectedVoice, setSelectedVoice] = useState(null);
      const [showVoiceModal, setShowVoiceModal] = useState(false);

      // Initialize speech recognition and synthesis
      useEffect(() => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          setIsVoiceSupported(false);
          setError("This browser does not support voice input. Please use text input.");
        }

        // Load available voices and selected voice
        const loadVoices = () => {
          const availableVoices = window.speechSynthesis.getVoices();
          setVoices(availableVoices);
          const savedVoiceName = localStorage.getItem("selectedVoice");
          if (savedVoiceName) {
            const savedVoice = availableVoices.find(voice => voice.name === savedVoiceName);
            if (savedVoice) setSelectedVoice(savedVoice);
          }
        };
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
      }, []);

      // Load history from localStorage
      useEffect(() => {
        const savedHistory = localStorage.getItem("sarathiHistory");
        if (savedHistory) {
          setHistory(JSON.parse(savedHistory));
        }
      }, []);

      // Save history to localStorage
      useEffect(() => {
        localStorage.setItem("sarathiHistory", JSON.stringify(history));
      }, [history]);

      // Toggle dark mode
      useEffect(() => {
        if (darkMode) {
          document.body.classList.add("dark");
        } else {
          document.body.classList.remove("dark");
        }
      }, [darkMode]);

      // Call Awan API
      const callAwanApi = async (prompt, maxTokens = 1000) => {
        try {
          const response = await fetch("https://api.awanllm.com/v1/completions", {
            method: "POST",
            headers: {
              "Authorization": "Bearer 3b38e8c8-5a6b-4e7e-a373-f85048d14675", // REPLACE WITH YOUR AWAN API KEY
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "Awanllm-Llama-3-8B-Cumulus",
              prompt: prompt,
              max_tokens: maxTokens,
              temperature: 0.7
            })
          });
          if (response.status === 429) {
            throw new Error("Rate limit exceeded. Please wait a minute and try again.");
          }
          if (!response.ok) {
            throw new Error(`API error: ${response.statusText}`);
          }
          const data = await response.json();
          return data.choices[0].text.trim();
        } catch (err) {
          setError(err.message);
          return null;
        }
      };

      // Handle speech recognition
      const startListening = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;

        const recognition = new SpeechRecognition();
        recognition.lang = "en-IN"; // Use Indian English for recognition
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onresult = (event) => {
          let interimTranscript = "";
          let finalTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }
          setQuestion(finalTranscript || interimTranscript);
          if (finalTranscript) {
            recognition.stop();
            setIsListening(false);
            handleSubmit(); // Auto-submit when final transcript is received
          }
        };

        recognition.onerror = (event) => {
          setError("Voice input error: " + event.error);
          setIsListening(false);
        };

        recognition.onend = () => {
          setIsListening(false);
        };

        setIsListening(true);
        recognition.start();
      };

      // Stop listening
      const stopListening = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;

        const recognition = new SpeechRecognition();
        recognition.stop();
        setIsListening(false);
        if (question) {
          handleSubmit(); // Auto-submit if question exists when stopping manually
        }
      };

      // Handle speech synthesis
      const speakResponse = (text) => {
        if (!window.speechSynthesis) {
          setError("This browser does not support voice output.");
          return;
        }

        window.speechSynthesis.cancel(); // Stop any ongoing speech
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-IN"; // Prioritize Indian English

        // Prioritize Indian English male voices
        const preferredVoices = [
          "Microsoft Neerja Online (Natural)", // Indian-accented voice in Edge
          "Google हिन्दी"                     // Indian-accented voice in Chrome, if available for English
        ];
        const selectedVoiceFallback = voices.find(voice => preferredVoices.includes(voice.name)) || 
                                      voices.find(voice => voice.lang === "en-IN" && voice.name.toLowerCase().includes("male")) || 
                                      voices.find(voice => voice.lang === "en-IN") || 
                                      voices.find(voice => voice.lang === "en-US" && voice.name.toLowerCase().includes("male")) || 
                                      voices.find(voice => voice.lang === "en-US") || 
                                      voices[0];
        utterance.voice = selectedVoice || selectedVoiceFallback;
        utterance.rate = 0.8; // Slightly slower for a natural tone
        utterance.pitch = 0.9; // Slightly lower pitch for a deeper tone

        utterance.onstart = () => setIsSpeaking(true);
        utterance.onend = () => setIsSpeaking(false);
        utterance.onerror = () => {
          setError("Voice output error.");
          setIsSpeaking(false);
        };

        window.speechSynthesis.speak(utterance);
      };

      // Test a voice
      const testVoice = (voice) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance("This is a test of the voice.");
        utterance.lang = "en-IN";
        utterance.voice = voice;
        utterance.rate = 0.8;
        utterance.pitch = 0.9;
        window.speechSynthesis.speak(utterance);
      };

      // Select a voice
      const selectVoice = (voice) => {
        setSelectedVoice(voice);
        localStorage.setItem("selectedVoice", voice.name);
        setShowVoiceModal(false);
      };

      // Handle question submission
      const handleSubmit = async () => {
        if (!question) {
          setError("Please enter or speak a question or dilemma.");
          return;
        }
        setError("");
        setResponse("");
        setShloka("");
        setTranslation("");
        setExplanation("");
        let prompt = "";
        let isFollowUp = false;
        let originalQuestion = null;
        const isVoiceInput = isListening || question !== ""; // Consider it voice input if triggered via speech

        if (followUpContext) {
          isFollowUp = true;
          originalQuestion = followUpContext.question;
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in English with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. The user has asked a follow-up question based on this previous interaction:

**Previous Question**: ${followUpContext.question}
**Previous Response**: ${followUpContext.response}
**Previous Shloka**: ${followUpContext.shloka}
**Previous Translation**: ${followUpContext.translation}
**Previous Explanation**: ${followUpContext.explanation}

**Follow-Up Question**: "${question}"

Provide a response that continues the conversation, addressing the follow-up question with clarity. If relevant, include another shloka or refer to the previous one. Format the response as:
**Response**: [Your response in English]
**Shloka**: [Sanskrit shloka, if applicable, or "Previous shloka applies"]
**Translation**: [English translation, if applicable, or "Previous translation applies"]
**Explanation**: [Explanation in English, connecting to the follow-up question]`;
        } else {
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in English with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. For the user's question or dilemma: "${question}", provide:
1. A response in English embodying Krishna’s wisdom.
2. A relevant Sanskrit shloka from the Bhagavad Gita (provide the text).
3. The shloka’s English translation.
4. An explanation in English connecting the shloka to the user’s situation.
Format the response as:
**Response**: [Your response in English]
**Shloka**: [Sanskrit shloka]
**Translation**: [English translation]
**Explanation**: [Explanation in English]`;
        }

        const result = await callAwanApi(prompt);
        if (result) {
          const responseMatch = result.match(/\*\*Response\*\*:\s*([\s\S]*?)(?=\*\*Shloka\*\*:|$)/);
          const shlokaMatch = result.match(/\*\*Shloka\*\*:\s*([\s\S]*?)(?=\*\*Translation\*\*:|$)/);
          const translationMatch = result.match(/\*\*Translation\*\*:\s*([\s\S]*?)(?=\*\*Explanation\*\*:|$)/);
          const explanationMatch = result.match(/\*\*Explanation\*\*:\s*([\s\S]*)/);
          
          const newEntry = {
            timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
            question: question,
            response: responseMatch ? responseMatch[1].trim() : "",
            shloka: shlokaMatch ? shlokaMatch[1].trim() : "",
            translation: translationMatch ? translationMatch[1].trim() : "",
            explanation: explanationMatch ? explanationMatch[1].trim() : "",
            isFollowUp: isFollowUp,
            originalQuestion: originalQuestion,
            isVoiceInput: isVoiceInput
          };
          setHistory([...history, newEntry]);
          setResponse(newEntry.response);
          setShloka(newEntry.shloka);
          setTranslation(newEntry.translation);
          setExplanation(newEntry.explanation);
          setQuestion("");
          setFollowUpContext(null);
          if (!isSpeaking) {
            speakResponse(newEntry.response);
          }
        }
        setSidebarOpen(false);
        setIsListening(false);
      };

      // Start follow-up question
      const startFollowUp = () => {
        const latestEntry = history[history.length - 1];
        setFollowUpContext({
          question: latestEntry.question,
          response: latestEntry.response,
          shloka: latestEntry.shloka,
          translation: latestEntry.translation,
          explanation: latestEntry.explanation
        });
      };

      // Cancel follow-up
      const cancelFollowUp = () => {
        setFollowUpContext(null);
        setQuestion("");
      };

      // Export history
      const exportHistory = () => {
        const exportText = history
          .map(entry => `${entry.timestamp}\n${entry.isVoiceInput ? "Voice Question" : "Question"}: ${entry.question}${entry.isFollowUp ? `\nFollow-up Question (Original: ${entry.originalQuestion})` : ""}\nResponse: ${entry.response}\nShloka: ${entry.shloka}\nTranslation: ${entry.translation}\nExplanation: ${entry.explanation}\n---\n`)
          .join("");
        const blob = new Blob([exportText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "sarathi_guidance_history.txt";
        a.click();
        URL.revokeObjectURL(url);
        setSidebarOpen(false);
      };

      // Clear history
      const clearHistory = () => {
        setHistory([]);
        localStorage.removeItem("sarathiHistory");
        setShowHistory(false);
        setSidebarOpen(false);
      };

      return (
        <div className={`min-h-screen ${darkMode ? "dark" : ""}`}>
          {/* Hamburger Menu */}
          <button
            className="fixed top-4 left-4 sm:top-2 sm:left-2 md:hidden hamburger-menu z-50 icon-button"
            onClick={() => setSidebarOpen(true)}
          >
            <svg className="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
          </button>

          {/* Sidebar */}
          <div
            className={`fixed inset-y-0 left-0 w-56 sm:w-3/4 md:w-56 bg-purple-800 dark:bg-purple-900 text-white transform ${sidebarOpen ? "translate-x-0" : "-translate-x-full"} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 shadow-lg sidebar`}
          >
            <div className="p-4 sm:p-3 flex justify-between items-center">
              <h2 className="text-xl sm:text-lg font-semibold">Saarathi</h2>
              <button className="md:hidden text-gray-200 icon-button" onClick={() => setSidebarOpen(false)}>
                <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <nav className="p-4 sm:p-3 space-y-2">
              <button
                className="w-full flex items-center p-3 sm:p-2 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition text-base sm:text-sm button"
                onClick={() => { setShowHistory(false); setSidebarOpen(false); setFollowUpContext(null); }}
              >
                <svg className="w-5 h-5 mr-2 sm:mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-4l7-7 4 4 7-7" />
                </svg>
                Ask a Question
              </button>
              <button
                className="w-full flex items-center p-3 sm:p-2 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition text-base sm:text-sm button"
                onClick={() => { setShowHistory(true); setSidebarOpen(false); }}
              >
                <svg className="w-5 h-5 mr-2 sm:mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                History
              </button>
              <button
                className="w-full flex items-center p-3 sm:p-2 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition text-base sm:text-sm button"
                onClick={() => { setShowVoiceModal(true); setSidebarOpen(false); }}
              >
                <svg className="w-5 h-5 mr-2 sm:mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                Select Voice
              </button>
              <button
                className="w-full flex items-center p-3 sm:p-2 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition text-base sm:text-sm button"
                onClick={() => { setDarkMode(!darkMode); setSidebarOpen(false); }}
              >
                <svg className="w-5 h-5 mr-2 sm:mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 0118 0z" />
                </svg>
                {darkMode ? "Light Mode" : "Dark Mode"}
              </button>
            </nav>
          </div>

          {/* Overlay for Mobile Sidebar */}
          {sidebarOpen && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 md:hidden z-30"
              onClick={() => setSidebarOpen(false)}
            ></div>
          )}

          {/* Main Content */}
          <main className="container mx-auto p-4 sm:p-5 md:p-10 pt-16 sm:pt-12 md:pt-0 flex justify-center">
            <div className="w-full max-w-3xl">
              {/* Error Message */}
              {error && (
                <div className="glass p-4 sm:p-5 mb-4 sm:mb-6 text-red-600 dark:text-red-400 fade-in-scale text-base sm:text-lg">
                  {error}
                </div>
              )}

              {/* Input Form */}
              <div className="glass p-6 sm:p-8 mb-4 sm:mb-6 fade-in-scale">
                {followUpContext && (
                  <div className="mb-3 sm:mb-4 text-sm sm:text-base text-gray-600 dark:text-gray-300">
                    Asking a follow-up question for: <span className="font-semibold">{followUpContext.question}</span>
                    <button
                      onClick={cancelFollowUp}
                      className="ml-2 text-blue-600 hover:underline"
                    >
                      Cancel
                    </button>
                  </div>
                )}
                <label className="block text-base sm:text-lg md:text-xl font-semibold mb-2 sm:mb-3 text-gray-800 dark:text-gray-200">
                  Enter or speak your question or dilemma (e.g., "I struggle to control anger at work")
                </label>
                <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4">
                  <textarea
                    value={question}
                    onChange={(e) => setQuestion(e.target.value)}
                    placeholder={followUpContext ? "Enter or speak a follow-up question" : "e.g., I struggle to control anger at work"}
                    className="w-full p-3 sm:p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 text-base sm:text-lg textarea"
                    rows="3"
                  />
                  {isVoiceSupported && (
                    <button
                      onClick={isListening ? stopListening : startListening}
                      className={`p-3 sm:p-4 rounded-full ${isListening ? "bg-red-500 mic-active" : "bg-blue-500"} text-white hover:bg-opacity-80 transition icon-button`}
                      disabled={isSpeaking}
                    >
                      <svg className="w-6 h-6 sm:w-7 sm:h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        {isListening ? (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        )}
                      </svg>
                    </button>
                  )}
                </div>
                <button
                  onClick={handleSubmit}
                  className="mt-3 sm:mt-4 bg-blue-500 text-white px-5 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-blue-600 transition transform hover:scale-105 w-full sm:w-auto flex items-center justify-center text-base sm:text-lg button"
                  disabled={isListening || isSpeaking}
                >
                  <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                  </svg>
                  Get Guidance
                </button>
              </div>

              {/* Output */}
              {(response || shloka || translation || explanation) && (
                <div className="glass p-6 sm:p-8 mb-4 sm:mb-6 fade-in-scale">
                  <div className="flex justify-between items-center mb-3 sm:mb-4">
                    <h3 className="text-lg sm:text-xl md:text-2xl font-semibold text-gray-800 dark:text-gray-200">
                      Krishna's Guidance
                    </h3>
                    {isVoiceSupported && (
                      <button
                        onClick={() => speakResponse(response)}
                        className={`p-2 sm:p-3 rounded-full ${isSpeaking ? "bg-yellow-500" : "bg-green-500"} text-white hover:bg-opacity-80 transition icon-button`}
                        disabled={isListening || isSpeaking}
                      >
                        <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5v14a1 1 0 01-1.707.707L5.586 15z" />
                        </svg>
                      </button>
                    )}
                  </div>
                  {response && (
                    <div className="mb-4 sm:mb-5">
                      <h4 className="font-semibold text-base sm:text-lg md:text-xl text-gray-800 dark:text-gray-200 mb-2">Response:</h4>
                      <div className="output-block text-base sm:text-lg">{response}</div>
                    </div>
                  )}
                  {shloka && (
                    <div className="mb-4 sm:mb-5">
                      <h4 className="font-semibold text-base sm:text-lg md:text-xl text-gray-800 dark:text-gray-200 mb-2">Shloka:</h4>
                      <div className="output-block text-base sm:text-lg sanskrit">{shloka}</div>
                    </div>
                  )}
                  {translation && (
                    <div className="mb-4 sm:mb-5">
                      <h4 className="font-semibold text-base sm:text-lg md:text-xl text-gray-800 dark:text-gray-200 mb-2">Translation:</h4>
                      <div className="output-block text-base sm:text-lg">{translation}</div>
                    </div>
                  )}
                  {explanation && (
                    <div className="mb-4 sm:mb-5">
                      <h4 className="font-semibold text-base sm:text-lg md:text-xl text-gray-800 dark:text-gray-200 mb-2">Explanation:</h4>
                      <div className="output-block text-base sm:text-lg">{explanation}</div>
                    </div>
                  )}
                  <button
                    onClick={startFollowUp}
                    className="mt-3 sm:mt-4 bg-yellow-500 text-white px-5 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105 flex items-center justify-center text-base sm:text-lg w-full sm:w-auto button"
                    disabled={isListening || isSpeaking}
                  >
                    <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                    Ask a Follow-up Question
                  </button>
                </div>
              )}
            </div>
          </main>

          {/* History Modal */}
          {showHistory && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
              <div className="glass p-4 sm:p-8 max-h-[90vh] overflow-y-auto w-full max-w-3xl modal modal-content">
                <div className="flex justify-between items-center mb-3 sm:mb-5">
                  <h3 className="text-lg sm:text-xl md:text-2xl font-semibold text-gray-800 dark:text-gray-200">
                    History
                  </h3>
                  <button
                    onClick={() => setShowHistory(false)}
                    className="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 icon-button"
                  >
                    <svg className="w-6 h-6 sm:w-7 sm:h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                {history.length === 0 ? (
                  <p className="text-gray-600 dark:text-gray-300 text-base sm:text-lg">No history available.</p>
                ) : (
                  history.map((entry, index) => (
                    <div key={index} className="mb-4 sm:mb-5 p-4 sm:p-5 bg-white dark:bg-gray-700 rounded-lg">
                      <p className="text-sm sm:text-base text-gray-500 dark:text-gray-400">{entry.timestamp}</p>
                      <p className="text-sm sm:text-base text-gray-600 dark:text-gray-300">
                        {entry.isVoiceInput ? "Voice Question" : "Question"}: {entry.question}
                        {entry.isFollowUp && ` (Follow-up, Original: ${entry.originalQuestion})`}
                      </p>
                      <p className="text-base sm:text-lg">Response: {entry.response}</p>
                      <p className="text-base sm:text-lg sanskrit">Shloka: {entry.shloka}</p>
                      <p className="text-base sm:text-lg">Translation: {entry.translation}</p>
                      <p className="text-base sm:text-lg">Explanation: {entry.explanation}</p>
                    </div>
                  ))
                )}
                <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                  <button
                    onClick={exportHistory}
                    className="bg-green-500 text-white px-5 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-green-600 transition transform hover:scale-105 w-full sm:w-auto text-base sm:text-lg button"
                  >
                    Export History
                  </button>
                  <button
                    onClick={clearHistory}
                    className="bg-red-500 text-white px-5 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-red-600 transition transform hover:scale-105 w-full sm:w-auto text-base sm:text-lg button"
                  >
                    Clear History
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Voice Selection Modal */}
          {showVoiceModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
              <div className="glass p-4 sm:p-8 max-h-[90vh] overflow-y-auto w-full max-w-3xl modal modal-content">
                <div className="flex justify-between items-center mb-3 sm:mb-5">
                  <h3 className="text-lg sm:text-xl md:text-2xl font-semibold text-gray-800 dark:text-gray-200">
                    Select Voice
                  </h3>
                  <button
                    onClick={() => setShowVoiceModal(false)}
                    className="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 icon-button"
                  >
                    <svg className="w-6 h-6 sm:w-7 sm:h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                {voices.length === 0 ? (
                  <p className="text-gray-600 dark:text-gray-300 text-base sm:text-lg">No voices available.</p>
                ) : (
                  voices.map((voice, index) => (
                    <div key={index} className="mb-3 sm:mb-4 p-3 sm:p-4 bg-white dark:bg-gray-700 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0">
                      <div>
                        <p className="text-base sm:text-lg font-semibold">{voice.name}</p>
                        <p className="text-sm sm:text-base text-gray-600 dark:text-gray-300">Language: {voice.lang}</p>
                      </div>
                      <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <button
                          onClick={() => testVoice(voice)}
                          className="bg-blue-500 text-white px-4 sm:px-5 py-2 sm:py-2 rounded-lg hover:bg-blue-600 transition text-sm sm:text-base w-full sm:w-auto button"
                        >
                          Test Voice
                        </button>
                        <button
                          onClick={() => selectVoice(voice)}
                          className="bg-green-500 text-white px-4 sm:px-5 py-2 sm:py-2 rounded-lg hover:bg-green-600 transition text-sm sm:text-base w-full sm:w-auto button"
                        >
                          Select
                        </button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
