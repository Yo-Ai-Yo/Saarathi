<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>সারথি</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Noto+Sans+Devanagari:wght@400;600&family=Noto+Serif+Bengali:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding-bottom: 80px; /* Space for bottom nav bar */
    }
    .bengali-text {
      font-family: 'Noto Serif Bengali', serif;
    }
    /* Modern card effect */
    .modern-card {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border: 2px solid #90caf9;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .modern-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }
    /* Neumorphic button style */
    .neumorphic-btn {
      background: #e1bee7;
      border: none;
      border-radius: 12px;
      box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.1), -4px -4px 12px rgba(255, 255, 255, 0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .neumorphic-btn:active {
      transform: scale(0.98);
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1), -2px -2px 8px rgba(255, 255, 255, 0.5);
    }
    /* Animations */
    @keyframes slideInBounce {
      0% { opacity: 0; transform: translateY(20px); }
      70% { transform: translateY(-4px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .slide-in-bounce {
      animation: slideInBounce 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    /* Background gradient */
    .bg-spiritual {
      background: linear-gradient(to bottom, #d1c4e9, #bbdefb);
    }
    /* Bottom navigation bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid #90caf9;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 50;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #6a1b9a;
      font-size: 12px;
      padding: 8px;
      transition: color 0.3s ease;
    }
    .nav-item.active {
      color: #42a5f5;
    }
    /* Output block styling */
    .output-block {
      background-color: #f3e8ff;
      border-radius: 12px;
      padding: 14px;
      overflow-x: auto;
    }
    /* Sanskrit text styling */
    .sanskrit {
      font-family: 'Noto Sans Devanagari', sans-serif;
      font-weight: 600;
      color: #b89746;
    }
    /* Smooth scroll behavior */
    .smooth-scroll {
      scroll-behavior: smooth;
    }
    /* Full-screen history view on mobile */
    .history-view {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f3e8ff;
      z-index: 40;
      overflow-y: auto;
      padding: 16px;
    }
  </style>
</head>
<body className="bg-spiritual min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [question, setQuestion] = useState("");
      const [response, setResponse] = useState("");
      const [shloka, setShloka] = useState("");
      const [translation, setTranslation] = useState("");
      const [explanation, setExplanation] = useState("");
      const [error, setError] = useState("");
      const [history, setHistory] = useState([]);
      const [showHistory, setShowHistory] = useState(false);
      const [followUpContext, setFollowUpContext] = useState(null);

      // Load history from localStorage on mount
      useEffect(() => {
        const savedHistory = localStorage.getItem("sarathiHistory");
        if (savedHistory) {
          setHistory(JSON.parse(savedHistory));
        }
      }, []);

      // Save history to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem("sarathiHistory", JSON.stringify(history));
      }, [history]);

      // Call Awan API with error handling
      const callAwanApi = async (prompt, maxTokens = 1000) => {
        try {
          const response = await fetch("https://api.awanllm.com/v1/completions", {
            method: "POST",
            headers: {
              "Authorization": "Bearer 3b38e8c8-5a6b-4e7e-a373-f85048d14675", // REPLACE WITH YOUR AWAN API KEY
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "Awanllm-Llama-3-8B-Cumulus",
              prompt: prompt,
              max_tokens: maxTokens,
              temperature: 0.7
            })
          });
          if (response.status === 429) {
            throw new Error("হারের সীমা অতিক্রম করেছে। দয়া করে এক মিনিট অপেক্ষা করে আবার চেষ্টা করুন।");
          }
          if (!response.ok) {
            throw new Error(`API ত্রুটি: ${response.statusText}`);
          }
          const data = await response.json();
          return data.choices[0].text.trim();
        } catch (err) {
          setError(err.message);
          return null;
        }
      };

      // Handle question submission
      const handleSubmit = async () => {
        if (!question) {
          setError("দয়া করে একটি প্রশ্ন বা দ্বিধা লিখুন।");
          return;
        }
        setError("");
        setResponse("");
        setShloka("");
        setTranslation("");
        setExplanation("");
        let prompt = "";
        let isFollowUp = false;
        let originalQuestion = null;

        if (followUpContext) {
          isFollowUp = true;
          originalQuestion = followUpContext.question;
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in Bengali with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. The user has asked a follow-up question based on this previous interaction:

**Previous Question**: ${followUpContext.question}
**Previous Response**: ${followUpContext.response}
**Previous Shloka**: ${followUpContext.shloka}
**Previous Translation**: ${followUpContext.translation}
**Previous Explanation**: ${followUpContext.explanation}

**Follow-Up Question**: "${question}"

Provide a response that continues the conversation, addressing the follow-up question with clarity. If relevant, include another shloka or refer to the previous one. Format the response as:
**Response**: [Your response in Bengali]
**Shloka**: [Sanskrit shloka, if applicable, or "পূর্ববর্তী শ্লোক প্রযোজ্য" if referring to the previous]
**Translation**: [Bengali translation, if applicable, or "পূর্ববর্তী অনুবাদ প্রযোজ্য"]
**Explanation**: [Explanation in Bengali, connecting to the follow-up question]`;
        } else {
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in Bengali with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. For the user's question or dilemma: "${question}", provide:
1. A response in Bengali embodying Krishna’s wisdom.
2. A relevant Sanskrit shloka from the Bhagavad Gita (provide the text).
3. The shloka’s Bengali translation.
4. An explanation in Bengali connecting the shloka to the user’s situation.
Format the response as:
**Response**: [Your response in Bengali]
**Shloka**: [Sanskrit shloka]
**Translation**: [Bengali translation]
**Explanation**: [Explanation in Bengali]`;
        }

        const result = await callAwanApi(prompt);
        if (result) {
          const responseMatch = result.match(/\*\*Response\*\*:\s*([\s\S]*?)(?=\*\*Shloka\*\*:|$)/);
          const shlokaMatch = result.match(/\*\*Shloka\*\*:\s*([\s\S]*?)(?=\*\*Translation\*\*:|$)/);
          const translationMatch = result.match(/\*\*Translation\*\*:\s*([\s\S]*?)(?=\*\*Explanation\*\*:|$)/);
          const explanationMatch = result.match(/\*\*Explanation\*\*:\s*([\s\S]*)/);
          
          const newEntry = {
            timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
            question: question,
            response: responseMatch ? responseMatch[1].trim() : "",
            shloka: shlokaMatch ? shlokaMatch[1].trim() : "",
            translation: translationMatch ? translationMatch[1].trim() : "",
            explanation: explanationMatch ? explanationMatch[1].trim() : "",
            isFollowUp: isFollowUp,
            originalQuestion: originalQuestion
          };
          setHistory([...history, newEntry]);
          setResponse(newEntry.response);
          setShloka(newEntry.shloka);
          setTranslation(newEntry.translation);
          setExplanation(newEntry.explanation);
          setQuestion("");
          setFollowUpContext(null);
        }
      };

      // Start follow-up question
      const startFollowUp = () => {
        const latestEntry = history[history.length - 1];
        setFollowUpContext({
          question: latestEntry.question,
          response: latestEntry.response,
          shloka: latestEntry.shloka,
          translation: latestEntry.translation,
          explanation: latestEntry.explanation
        });
      };

      // Cancel follow-up
      const cancelFollowUp = () => {
        setFollowUpContext(null);
        setQuestion("");
      };

      // Export history
      const exportHistory = () => {
        const exportText = history
          .map(entry => `${entry.timestamp}\nপ্রশ্ন: ${entry.question}${entry.isFollowUp ? `\nফলো-আপ প্রশ্ন (মূল: ${entry.originalQuestion})` : ""}\nউত্তর: ${entry.response}\nশ্লোক: ${entry.shloka}\nঅনুবাদ: ${entry.translation}\nব্যাখ্যা: ${entry.explanation}\n---\n`)
          .join("");
        const blob = new Blob([exportText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "sarathi_guidance_history.txt";
        a.click();
        URL.revokeObjectURL(url);
      };

      // Clear history
      const clearHistory = () => {
        setHistory([]);
        localStorage.removeItem("sarathiHistory");
        setShowHistory(false);
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="p-5 text-center">
            <h1 className="text-2xl md:text-3xl font-semibold bengali-text text-gray-800 shadow-md">
              সারথি
            </h1>
          </header>

          {/* Main Content */}
          {!showHistory ? (
            <main className="container mx-auto p-4 md:p-6 flex justify-center">
              <div className="w-full max-w-2xl space-y-6">
                {/* Error Message */}
                {error && (
                  <div className="modern-card p-4 text-red-600 slide-in-bounce bengali-text text-base">
                    {error}
                  </div>
                )}

                {/* Input Card */}
                <div className="modern-card p-6 slide-in-bounce">
                  {followUpContext && (
                    <div className="mb-3 text-base text-gray-600 bengali-text">
                      ফলো-আপ প্রশ্ন করছেন এই প্রশ্নের জন্য: <span className="font-medium">{followUpContext.question}</span>
                      <button
                        onClick={cancelFollowUp}
                        className="ml-2 text-blue-600 hover:underline bengali-text text-sm"
                      >
                        বাতিল
                      </button>
                    </div>
                  )}
                  <label className="block text-lg font-medium mb-2 text-gray-800 bengali-text">
                    আপনার প্রশ্ন বা দ্বিধা লিখুন
                  </label>
                  <textarea
                    value={question}
                    onChange={(e) => setQuestion(e.target.value)}
                    placeholder={followUpContext ? "ফলো-আপ প্রশ্ন লিখুন" : "যেমন, আমি কর্মক্ষেত্রে রাগ নিয়ন্ত্রণ করতে পারছি না"}
                    className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-base bengali-text"
                    rows="4"
                  />
                  <button
                    onClick={handleSubmit}
                    className="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg neumorphic-btn w-full flex items-center justify-center text-base bengali-text"
                  >
                    <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                    </svg>
                    নির্দেশনা পান
                  </button>
                </div>

                {/* Output Card */}
                {(response || shloka || translation || explanation) && (
                  <div className="modern-card p-6 slide-in-bounce">
                    <h3 className="text-xl font-semibold mb-3 text-gray-800 bengali-text">
                      শ্রীকৃষ্ণের নির্দেশনা
                    </h3>
                    {response && (
                      <div className="mb-4">
                        <h4 className="font-medium text-lg text-gray-800 bengali-text mb-1">উত্তর:</h4>
                        <div className="output-block text-base bengali-text">{response}</div>
                      </div>
                    )}
                    {shloka && (
                      <div className="mb-4">
                        <h4 className="font-medium text-lg text-gray-800 bengali-text mb-1">শ্লোক:</h4>
                        <div className="output-block text-base sanskrit">{shloka}</div>
                      </div>
                    )}
                    {translation && (
                      <div className="mb-4">
                        <h4 className="font-medium text-lg text-gray-800 bengali-text mb-1">অনুবাদ:</h4>
                        <div className="output-block text-base bengali-text">{translation}</div>
                      </div>
                    )}
                    {explanation && (
                      <div className="mb-4">
                        <h4 className="font-medium text-lg text-gray-800 bengali-text mb-1">ব্যাখ্যা:</h4>
                        <div className="output-block text-base bengali-text">{explanation}</div>
                      </div>
                    )}
                    <button
                      onClick={startFollowUp}
                      className="mt-4 bg-yellow-500 text-white px-6 py-3 rounded-lg neumorphic-btn w-full flex items-center justify-center text-base bengali-text"
                    >
                      <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                      ফলো-আপ প্রশ্ন করুন
                    </button>
                  </div>
                )}
              </div>
            </main>
          ) : (
            <div className="history-view smooth-scroll fade-in">
              <div className="flex justify-between items-center mb-5">
                <button
                  onClick={() => setShowHistory(false)}
                  className="text-gray-600 hover:text-gray-800"
                >
                  <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h3 className="text-xl font-semibold text-gray-800 bengali-text">
                  ইতিহাস
                </h3>
                <div className="w-6"></div> {/* Spacer for alignment */}
              </div>
              {history.length === 0 ? (
                <p className="text-gray-600 bengali-text text-base text-center">কোনো ইতিহাস নেই।</p>
              ) : (
                history.map((entry, index) => (
                  <div key={index} className="mb-4 p-4 bg-white rounded-lg shadow-sm">
                    <p className="text-sm text-gray-500 bengali-text">{entry.timestamp}</p>
                    {entry.isFollowUp && (
                      <p className="text-sm text-gray-600 bengali-text">
                        ফলো-আপ প্রশ্ন (মূল: {entry.originalQuestion})
                      </p>
                    )}
                    <p className="font-medium text-base text-gray-800 bengali-text">
                      প্রশ্ন: {entry.question}
                    </p>
                    <p className="text-base bengali-text">উত্তর: {entry.response}</p>
                    <p className="text-base sanskrit">শ্লোক: {entry.shloka}</p>
                    <p className="text-base bengali-text">অনুবাদ: {entry.translation}</p>
                    <p className="text-base bengali-text">ব্যাখ্যা: {entry.explanation}</p>
                  </div>
                ))
              )}
              {history.length > 0 && (
                <div className="mt-6 flex flex-col gap-3">
                  <button
                    onClick={exportHistory}
                    className="bg-green-500 text-white px-6 py-3 rounded-lg neumorphic-btn text-base bengali-text"
                  >
                    ইতিহাস রপ্তানি করুন
                  </button>
                  <button
                    onClick={clearHistory}
                    className="bg-red-500 text-white px-6 py-3 rounded-lg neumorphic-btn text-base bengali-text"
                  >
                    ইতিহাস মুছুন
                  </button>
                </div>
              )}
            </div>
          )}

          {/* Bottom Navigation Bar */}
          <div className="bottom-nav">
            <button
              className={`nav-item ${!showHistory ? 'active' : ''}`}
              onClick={() => { setShowHistory(false); setFollowUpContext(null); }}
            >
              <svg className="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-4l7-7 4 4 7-7" />
              </svg>
              <span className="bengali-text">প্রশ্ন</span>
            </button>
            <button
              className={`nav-item ${showHistory ? 'active' : ''}`}
              onClick={() => setShowHistory(true)}
            >
              <svg className="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="bengali-text">ইতিহাস</span>
            </button>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
