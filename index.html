<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>সারথি</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Noto+Sans+Devanagari:wght@400;600&family=Noto+Serif+Bengali:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .bengali-text {
      font-family: 'Noto Serif Bengali', serif;
    }
    /* Glassmorphism effect with updated border */
    .glass {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border: 2px solid #90caf9;
      border-radius: 16px;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .dark .glass {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid #90caf9;
    }
    /* Animations */
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .fade-in-scale {
      animation: fadeInScale 0.3s ease-in-out;
    }
    /* Updated background gradient */
    .bg-spiritual {
      background: linear-gradient(to bottom, #d1c4e9, #bbdefb);
    }
    .dark .bg-spiritual {
      background: linear-gradient(to bottom, #4a148c, #0d47a1);
    }
    /* Mobile sidebar transition */
    .sidebar-enter {
      transform: translateX(-100%);
    }
    .sidebar-enter-active {
      transform: translateX(0);
      transition: transform 300ms ease-in-out;
    }
    .sidebar-exit {
      transform: translateX(0);
    }
    .sidebar-exit-active {
      transform: translateX(-100%);
      transition: transform 300ms ease-in-out;
    }
    /* Hamburger menu styling */
    .hamburger-menu {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }
    /* Output block styling */
    .output-block {
      background-color: #f3e8ff;
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
    }
    .dark .output-block {
      background-color: #1e1b4b;
      color: #e5e7eb;
    }
    /* Sanskrit text styling */
    .sanskrit {
      font-family: 'Noto Sans Devanagari', sans-serif;
      font-weight: 600;
      color: #b89746;
    }
    .dark .sanskrit {
      color: #ffca28;
    }
  </style>
</head>
<body className="bg-spiritual min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [question, setQuestion] = useState("");
      const [response, setResponse] = useState("");
      const [shloka, setShloka] = useState("");
      const [translation, setTranslation] = useState("");
      const [explanation, setExplanation] = useState("");
      const [error, setError] = useState("");
      const [darkMode, setDarkMode] = useState(false);
      const [history, setHistory] = useState([]);
      const [showHistory, setShowHistory] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [followUpContext, setFollowUpContext] = useState(null);

      // Load history from localStorage on mount
      useEffect(() => {
        const savedHistory = localStorage.getItem("sarathiHistory");
        if (savedHistory) {
          setHistory(JSON.parse(savedHistory));
        }
      }, []);

      // Save history to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem("sarathiHistory", JSON.stringify(history));
      }, [history]);

      // Toggle dark mode
      useEffect(() => {
        if (darkMode) {
          document.body.classList.add("dark");
        } else {
          document.body.classList.remove("dark");
        }
      }, [darkMode]);

      // Call Awan API with error handling
      const callAwanApi = async (prompt, maxTokens = 1000) => {
        try {
          const response = await fetch("https://api.awanllm.com/v1/completions", {
            method: "POST",
            headers: {
              "Authorization": "Bearer 3b38e8c8-5a6b-4e7e-a373-f85048d14675", // REPLACE WITH YOUR AWAN API KEY
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "Awanllm-Llama-3-8B-Cumulus",
              prompt: prompt,
              max_tokens: maxTokens,
              temperature: 0.7
            })
          });
          if (response.status === 429) {
            throw new Error("হারের সীমা অতিক্রম করেছে। দয়া করে এক মিনিট অপেক্ষা করে আবার চেষ্টা করুন।");
          }
          if (!response.ok) {
            throw new Error(`API ত্রুটি: ${response.statusText}`);
          }
          const data = await response.json();
          return data.choices[0].text.trim();
        } catch (err) {
          setError(err.message);
          return null;
        }
      };

      // Handle question submission
      const handleSubmit = async () => {
        if (!question) {
          setError("দয়া করে একটি প্রশ্ন বা দ্বিধা লিখুন।");
          return;
        }
        setError("");
        setResponse("");
        setShloka("");
        setTranslation("");
        setExplanation("");
        let prompt = "";
        let isFollowUp = false;
        let originalQuestion = null;

        if (followUpContext) {
          isFollowUp = true;
          originalQuestion = followUpContext.question;
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in Bengali with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. The user has asked a follow-up question based on this previous interaction:

**Previous Question**: ${followUpContext.question}
**Previous Response**: ${followUpContext.response}
**Previous Shloka**: ${followUpContext.shloka}
**Previous Translation**: ${followUpContext.translation}
**Previous Explanation**: ${followUpContext.explanation}

**Follow-Up Question**: "${question}"

Provide a response that continues the conversation, addressing the follow-up question with clarity. If relevant, include another shloka or refer to the previous one. Format the response as:
**Response**: [Your response in Bengali]
**Shloka**: [Sanskrit shloka, if applicable, or "পূর্ববর্তী শ্লোক প্রযোজ্য" if referring to the previous]
**Translation**: [Bengali translation, if applicable, or "পূর্ববর্তী অনুবাদ প্রযোজ্য"]
**Explanation**: [Explanation in Bengali, connecting to the follow-up question]`;
        } else {
          prompt = `Act as Lord Krishna from the Bhagavad Gita, responding in Bengali with a wise, compassionate, direct, and spiritual tone, free from ego, as a divine teacher. For the user's question or dilemma: "${question}", provide:
1. A response in Bengali embodying Krishna’s wisdom.
2. A relevant Sanskrit shloka from the Bhagavad Gita (provide the text).
3. The shloka’s Bengali translation.
4. An explanation in Bengali connecting the shloka to the user’s situation.
Format the response as:
**Response**: [Your response in Bengali]
**Shloka**: [Sanskrit shloka]
**Translation**: [Bengali translation]
**Explanation**: [Explanation in Bengali]`;
        }

        const result = await callAwanApi(prompt);
        if (result) {
          const responseMatch = result.match(/\*\*Response\*\*:\s*([\s\S]*?)(?=\*\*Shloka\*\*:|$)/);
          const shlokaMatch = result.match(/\*\*Shloka\*\*:\s*([\s\S]*?)(?=\*\*Translation\*\*:|$)/);
          const translationMatch = result.match(/\*\*Translation\*\*:\s*([\s\S]*?)(?=\*\*Explanation\*\*:|$)/);
          const explanationMatch = result.match(/\*\*Explanation\*\*:\s*([\s\S]*)/);
          
          const newEntry = {
            timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
            question: question,
            response: responseMatch ? responseMatch[1].trim() : "",
            shloka: shlokaMatch ? shlokaMatch[1].trim() : "",
            translation: translationMatch ? translationMatch[1].trim() : "",
            explanation: explanationMatch ? explanationMatch[1].trim() : "",
            isFollowUp: isFollowUp,
            originalQuestion: originalQuestion
          };
          setHistory([...history, newEntry]);
          setResponse(newEntry.response);
          setShloka(newEntry.shloka);
          setTranslation(newEntry.translation);
          setExplanation(newEntry.explanation);
          setQuestion("");
          setFollowUpContext(null);
        }
        setSidebarOpen(false);
      };

      // Start follow-up question
      const startFollowUp = () => {
        const latestEntry = history[history.length - 1];
        setFollowUpContext({
          question: latestEntry.question,
          response: latestEntry.response,
          shloka: latestEntry.shloka,
          translation: latestEntry.translation,
          explanation: latestEntry.explanation
        });
      };

      // Cancel follow-up
      const cancelFollowUp = () => {
        setFollowUpContext(null);
        setQuestion("");
      };

      // Export history
      const exportHistory = () => {
        const exportText = history
          .map(entry => `${entry.timestamp}\nপ্রশ্ন: ${entry.question}${entry.isFollowUp ? `\nফলো-আপ প্রশ্ন (মূল: ${entry.originalQuestion})` : ""}\nউত্তর: ${entry.response}\nশ্লোক: ${entry.shloka}\nঅনুবাদ: ${entry.translation}\nব্যাখ্যা: ${entry.explanation}\n---\n`)
          .join("");
        const blob = new Blob([exportText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "sarathi_guidance_history.txt";
        a.click();
        URL.revokeObjectURL(url);
        setSidebarOpen(false);
      };

      // Clear history
      const clearHistory = () => {
        setHistory([]);
        localStorage.removeItem("sarathiHistory");
        setShowHistory(false);
        setSidebarOpen(false);
      };

      return (
        <div className={`min-h-screen ${darkMode ? "dark" : ""}`}>
          {/* Hamburger Menu for Mobile */}
          <button
            className="fixed top-4 left-4 md:hidden hamburger-menu z-50"
            onClick={() => setSidebarOpen(true)}
          >
            <svg className="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
          </button>

          {/* Sidebar */}
          <div
            className={`fixed inset-y-0 left-0 w-56 bg-purple-800 dark:bg-purple-900 text-white transform ${sidebarOpen ? "translate-x-0" : "-translate-x-full"} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 shadow-lg`}
          >
            <div className="p-5 flex justify-between items-center">
              <h2 className="text-xl font-semibold bengali-text">সারথি</h2>
              <button className="md:hidden text-gray-200" onClick={() => setSidebarOpen(false)}>
                <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <nav className="p-5 space-y-3">
              <button
                className="w-full flex items-center p-3 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition bengali-text text-base"
                onClick={() => { setShowHistory(false); setSidebarOpen(false); setFollowUpContext(null); }}
              >
                <svg className="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-4l7-7 4 4 7-7" />
                </svg>
                প্রশ্ন করুন
              </button>
              <button
                className="w-full flex items-center p-3 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition bengali-text text-base"
                onClick={() => { setShowHistory(true); setSidebarOpen(false); }}
              >
                <svg className="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ইতিহাস
              </button>
              <button
                className="w-full flex items-center p-3 rounded-lg hover:bg-purple-700 dark:hover:bg-purple-800 transition text-base"
                onClick={() => { setDarkMode(!darkMode); setSidebarOpen(false); }}
              >
                <svg className="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                {darkMode ? "আলোক মোড" : "অন্ধকার মোড"}
              </button>
            </nav>
          </div>

          {/* Overlay for Mobile Sidebar */}
          {sidebarOpen && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 md:hidden z-30"
              onClick={() => setSidebarOpen(false)}
            ></div>
          )}

          {/* Main Content */}
          <main className="container mx-auto p-5 md:p-10 pt-16 md:pt-0 flex justify-center">
            <div className="w-full max-w-3xl">
              {/* Error Message */}
              {error && (
                <div className="glass p-5 mb-6 text-red-600 dark:text-red-400 fade-in-scale bengali-text text-lg">
                  {error}
                </div>
              )}

              {/* Input Form */}
              <div className="glass p-8 mb-6 fade-in-scale">
                {followUpContext && (
                  <div className="mb-4 text-base text-gray-600 dark:text-gray-300 bengali-text">
                    ফলো-আপ প্রশ্ন করছেন এই প্রশ্নের জন্য: <span className="font-semibold">{followUpContext.question}</span>
                    <button
                      onClick={cancelFollowUp}
                      className="ml-2 text-blue-600 hover:underline bengali-text"
                    >
                      বাতিল
                    </button>
                  </div>
                )}
                <label className="block text-lg md:text-xl font-semibold mb-3 text-gray-800 dark:text-gray-200 bengali-text">
                  আপনার প্রশ্ন বা দ্বিধা লিখুন (যেমন, “আমি কর্মক্ষেত্রে রাগ নিয়ন্ত্রণ করতে পারছি না”)
                </label>
                <textarea
                  value={question}
                  onChange={(e) => setQuestion(e.target.value)}
                  placeholder={followUpContext ? "ফলো-আপ প্রশ্ন লিখুন" : "যেমন, আমি কর্মক্ষেত্রে রাগ নিয়ন্ত্রণ করতে পারছি না"}
                  className="w-full p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 text-lg bengali-text"
                  rows="4"
                />
                <button
                  onClick={handleSubmit}
                  className="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition transform hover:scale-105 w-full md:w-auto flex items-center justify-center text-lg bengali-text"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                  </svg>
                  নির্দেশনা পান
                </button>
              </div>

              {/* Output */}
              {(response || shloka || translation || explanation) && (
                <div className="glass p-8 mb-6 fade-in-scale">
                  <h3 className="text-xl md:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 bengali-text">
                    শ্রীকৃষ্ণের নির্দেশনা
                  </h3>
                  {response && (
                    <div className="mb-5">
                      <h4 className="font-semibold text-lg md:text-xl text-gray-800 dark:text-gray-200 bengali-text mb-2">উত্তর:</h4>
                      <div className="output-block text-lg bengali-text">{response}</div>
                    </div>
                  )}
                  {shloka && (
                    <div className="mb-5">
                      <h4 className="font-semibold text-lg md:text-xl text-gray-800 dark:text-gray-200 bengali-text mb-2">শ্লোক:</h4>
                      <div className="output-block text-lg sanskrit">{shloka}</div>
                    </div>
                  )}
                  {translation && (
                    <div className="mb-5">
                      <h4 className="font-semibold text-lg md:text-xl text-gray-800 dark:text-gray-200 bengali-text mb-2">অনুবাদ:</h4>
                      <div className="output-block text-lg bengali-text">{translation}</div>
                    </div>
                  )}
                  {explanation && (
                    <div className="mb-5">
                      <h4 className="font-semibold text-lg md:text-xl text-gray-800 dark:text-gray-200 bengali-text mb-2">ব্যাখ্যা:</h4>
                      <div className="output-block text-lg bengali-text">{explanation}</div>
                    </div>
                  )}
                  <button
                    onClick={startFollowUp}
                    className="mt-4 bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105 flex items-center justify-center text-lg bengali-text"
                  >
                    <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                    ফলো-আপ প্রশ্ন করুন
                  </button>
                </div>
              )}
            </div>
          </main>

          {/* History Modal */}
          {showHistory && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="glass p-8 max-h-[80vh] overflow-y-auto w-full max-w-3xl">
                <div className="flex justify-between items-center mb-5">
                  <h3 className="text-xl md:text-2xl font-semibold text-gray-800 dark:text-gray-200 bengali-text">
                    ইতিহাস
                  </h3>
                  <button
                    onClick={() => setShowHistory(false)}
                    className="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100"
                  >
                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                {history.length === 0 ? (
                  <p className="text-gray-600 dark:text-gray-300 bengali-text text-lg">কোনো ইতিহাস নেই।</p>
                ) : (
                  history.map((entry, index) => (
                    <div key={index} className="mb-5 p-5 bg-white dark:bg-gray-700 rounded-lg">
                      <p className="text-base text-gray-500 dark:text-gray-400 bengali-text">{entry.timestamp}</p>
                      {entry.isFollowUp && (
                        <p className="text-base text-gray-600 dark:text-gray-300 bengali-text">
                          ফলো-আপ প্রশ্ন (মূল: {entry.originalQuestion})
                        </p>
                      )}
                      <p className="font-semibold text-lg text-gray-800 dark:text-gray-200 bengali-text">
                        প্রশ্ন: {entry.question}
                      </p>
                      <p className="text-lg bengali-text">উত্তর: {entry.response}</p>
                      <p className="text-lg sanskrit">শ্লোক: {entry.shloka}</p>
                      <p className="text-lg bengali-text">অনুবাদ: {entry.translation}</p>
                      <p className="text-lg bengali-text">ব্যাখ্যা: {entry.explanation}</p>
                    </div>
                  ))
                )}
                <div className="flex flex-col md:flex-row gap-4">
                  <button
                    onClick={exportHistory}
                    className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition transform hover:scale-105 w-full md:w-auto text-lg bengali-text"
                  >
                    ইতিহাস রপ্তানি করুন
                  </button>
                  <button
                    onClick={clearHistory}
                    className="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition transform hover:scale-105 w-full md:w-auto text-lg bengali-text"
                  >
                    ইতিহাস মুছুন
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
